### 运算符左右两边类型不一致

- 03-netflix / old-movies

- 05-fifa22 / complex-label

- 05-fifa22 / bmi-calc

- 09-kickstarter / high-goal-fail

**错误示例**

- 操作 #1: '<' not supported between instances of 'str' and 'int'

- 操作 #1: 部分行计算失败: 行 540: '<' not supported between instances of 'datetime.datetime' and 'int'; 行 1679: '<' not supported between instances of 'datetime.datetime' and 'int'; 行 1796: '<' not supported between instances of 'datetime.datetime' and 'int'; 行 2305: '<' not supported between instances of 'datetime.datetime' and 'int'; 行 2341: '<' not supported between instances of 'datetime.datetime' and 'int' (共 213 个错误)

- 操作 #1: 部分行计算失败: 行 15: unsupported operand type(s) for /: 'datetime.datetime' and 'int'; 行 538: unsupported operand type(s) for /: 'datetime.datetime' and 'int'; 行 1280: unsupported operand type(s) for /: 'datetime.datetime' and 'int'; 行 1754: unsupported operand type(s) for /: 'datetime.datetime' and 'int'; 行 2301: unsupported operand type(s) for /: 'datetime.datetime' and 'int' (共 99 个错误)

- "操作 #1: '>' not supported between instances of 'datetime.datetime' and 'int'"

#### 类型系统说明

**三层类型转换：**

| 层级 | 类型系统 | 说明 |
|------|----------|------|
| Excel | 常规/数值/文本/日期/布尔/错误 | Excel 无严格列类型，同一列可混合存储 |
| pandas | int64/float64/object/datetime64/bool | `object` 是问题根源，可能包含混合类型 |
| 系统 | Number/Text/None/ExcelError | `models.py` 中定义的 Cell 类型 |

**pandas 读取 Excel 后的类型映射：**

| Excel 数据 | pandas dtype | 说明 |
|-----------|--------------|------|
| 纯整数（无空值） | int64 | |
| 纯整数（有空值） | **float64** | NaN 是 float，导致类型变化 |
| 小数 | float64 | |
| 纯文本 | object | |
| 混合类型 | **object** | 问题根源！同一列包含 str、int、float |
| 日期 | datetime64[ns] | |
| 布尔 | bool | |

**问题场景：**

1. **比较运算符** (`>`, `<`, `>=`, `<=`)：str 和 int/float 无法直接比较
2. **排序操作**：混合类型列无法直接排序
3. **filter 操作**：pandas 比较操作遇到混合类型会报错

**已修复** (executor.py)：

1. `_eval_binary_op`: 比较运算符增加类型转换和安全比较逻辑
2. `_execute_filter`: 对混合类型列进行类型转换后再比较
3. `_execute_sort`: 对 object 类型列尝试数值转换后排序

**修复策略：**

- 数值比较：尝试将字符串转为数值
- 无法转换时：模拟 Excel 行为（数值 < 文本）
- 排序：优先数值排序，数值优先于非数值
- 出错时返回 False 而不是抛出异常

### 引用不存在

- 05-fifa22 / nationality-stats

```json
{
  "success": false,
  "errors": [
    "操作 #1: 分组列 'X' 不存在于表 'players_22'",
    "操作 #2: Sheet '国籍统计' 不存在于文件 players_22.xlsx",
    "操作 #3: Sheet '国籍统计' 不存在于文件 players_22.xlsx"
  ]
}
```

已解决，生成阶段 系统提示词不传递列序号

### 不支持的函数: \*

05-fifa22 / wage-clean

```json
{
  "valid": false,
  "operation_count": 0,
  "errors": [
    "操作 #1 formula: 参数 1: 不支持的函数: *",
    "操作 #1 formula: 参数 1: 参数 1: 参数 1: 不支持的函数: SUBSTITUTE",
    "操作 #1 formula: 参数 1: 参数 1: 参数 1: 参数 1: 不支持的函数: SUBSTITUTE"
  ]
}
```

已解决，提示词增加 op 和 func 使用格式

## 列不存在

06-pokemon / name-length

```json
{
  "operations": {
    "operations": [
      {
        "type": "add_column",
        "description": "计算每个宝可梦名字的字符长度",
        "file_id": "pokemon",
        "table": "Pokemon",
        "name": "Name_Len",
        "formula": {
          "func": "LEN",
          "args": [
            {
              "col": "Name"
            }
          ]
        }
      },
      {
        "type": "filter",
        "description": "筛选出名字长度超过 10 个字符的行",
        "file_id": "pokemon",
        "table": "Pokemon",
        "conditions": [
          {
            "column": "Name_Len",
            "op": ">",
            "value": 10
          }
        ],
        "logic": "AND",
        "output": {
          "type": "new_sheet",
          "name": "长名字宝可梦"
        }
      }
    ]
  }
}
```

```json
{
  "success": false,
  "errors": ["操作 #2: 列 'Name_Len' 不存在于表 'Pokemon'"]
}
```
