name: Build and Push Docker Images

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      push_latest:
        description: "是否同时推送 latest 标签"
        required: false
        type: boolean
        default: false

  # Tag 推送时自动触发（例如：v1.0.0）
  push:
    tags:
      - "v*"

env:
  # 从 package.json 读取版本号（会在 job 中动态设置）
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 读取版本号
      - name: Get version from package.json
        id: package-version
        run: |
          VERSION=$(grep -o '"version": *"[^"]*"' package.json | sed 's/"version": *"\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "读取到版本号: $VERSION"

      # 3. 设置版本标签
      - name: Set version tags
        id: tags
        run: |
          VERSION="${{ steps.package-version.outputs.version }}"

          # 如果是 tag 触发，使用 tag 版本
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "使用版本标签: $VERSION"

      # 4. 设置 QEMU（用于多架构构建）
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 5. 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 7. 构建并推送 API 镜像
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/selgetabel-api:${{ steps.tags.outputs.version }}
            ${{ (github.ref_type == 'tag' || github.event.inputs.push_latest == 'true') && format('{0}/selgetabel-api:latest', env.DOCKER_USERNAME) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 8. 构建并推送 Web 镜像
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/selgetabel-web:${{ steps.tags.outputs.version }}
            ${{ (github.ref_type == 'tag' || github.event.inputs.push_latest == 'true') && format('{0}/selgetabel-web:latest', env.DOCKER_USERNAME) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 9. 输出构建信息
      - name: Output build info
        run: |
          echo "=========================================="
          echo "✅ Docker 镜像构建和推送完成！"
          echo "=========================================="
          echo "版本: ${{ steps.tags.outputs.version }}"
          echo ""
          echo "镜像列表:"
          echo "  - ${{ env.DOCKER_USERNAME }}/selgetabel-api:${{ steps.tags.outputs.version }}"
          echo "  - ${{ env.DOCKER_USERNAME }}/selgetabel-web:${{ steps.tags.outputs.version }}"
          if [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ github.event.inputs.push_latest }}" == "true" ]]; then
            echo "  - ${{ env.DOCKER_USERNAME }}/selgetabel-api:latest"
            echo "  - ${{ env.DOCKER_USERNAME }}/selgetabel-web:latest"
          fi
          echo ""
          echo "支持架构: linux/amd64, linux/arm64"
          echo "=========================================="
